<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="On This Day">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=2">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%234A90D9'/%3E%3Cstop offset='100%25' stop-color='%238B5CF6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='28' fill='url(%23bg)'/%3E%3Crect x='30' y='44' width='120' height='106' rx='12' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Crect x='30' y='44' width='120' height='30' rx='12' fill='%23fff'/%3E%3Ccircle cx='60' cy='36' r='8' fill='%23fff'/%3E%3Ccircle cx='120' cy='36' r='8' fill='%23fff'/%3E%3Cline x1='60' y1='28' x2='60' y2='44' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3Cline x1='120' y1='28' x2='120' y2='44' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='100' cy='115' r='22' fill='none' stroke='%23fff' stroke-width='5'/%3E%3Ccircle cx='100' cy='115' r='8' fill='%23fff'/%3E%3Crect x='82' y='97' width='36' height='6' rx='3' fill='%23fff' transform='rotate(-45 100 100)'/%3E%3C/svg%3E">
    <title>On This Day — {{MONTH_NAME}} {{DAY}}</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 2rem 1rem 1rem;
            border-bottom: 1px solid #222;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 300;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        header h1 span { font-weight: 600; }

        nav {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        nav a {
            color: #8ab4f8;
            text-decoration: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        nav a:hover { background: #1a1a2e; }

        main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        .year-section { margin-bottom: 2.5rem; }

        .year-header {
            font-size: 1.5rem;
            font-weight: 300;
            color: #aaa;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #1a1a1a;
            margin-bottom: 1rem;
        }

        .year-header span {
            color: #666;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .photo-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #111;
            aspect-ratio: 1;
        }

        .photo-card a {
            display: block;
            width: 100%;
            height: 100%;
            text-decoration: none;
            color: inherit;
        }

        .photo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .photo-card img:hover { transform: scale(1.03); }

        .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            font-size: 0.75rem;
            color: #bbb;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .photo-card:hover .photo-info { opacity: 1; }

        .video-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            transition: background 0.2s;
        }

        .video-card:hover .video-overlay { background: rgba(0, 0, 0, 0.15); }

        .play-icon {
            width: 48px;
            height: 48px;
            color: #fff;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
            transition: transform 0.2s;
        }

        .video-card:hover .play-icon { transform: scale(1.15); }

        .live-badge {
            position: absolute;
            top: 0.4rem;
            left: 0.4rem;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(8px);
            color: #fff;
            font-size: 0.6rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            letter-spacing: 0.05em;
            z-index: 1;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: #555;
        }

        .empty-state h2 { font-weight: 300; font-size: 1.5rem; margin-bottom: 0.5rem; }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox img, .lightbox video {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 4px;
        }

        .lightbox-close {
            position: fixed;
            top: 1rem;
            right: 1.5rem;
            color: #fff;
            font-size: 2rem;
            text-decoration: none;
            z-index: 1001;
            line-height: 1;
            cursor: pointer;
        }

        .lightbox-close:hover { color: #8ab4f8; }

        #lightbox-content > * {
            will-change: transform, opacity;
        }

        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #333;
            font-size: 0.8rem;
        }

        @media (max-width: 600px) {
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.5rem;
            }
            header h1 { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>On This Day — <span>{{MONTH_NAME}} {{DAY}}</span></h1>
        <nav>
            <a href="{{PREV_LINK}}">&larr; {{PREV_LABEL}}</a>
            <a href="/">Today</a>
            <a href="{{NEXT_LINK}}">{{NEXT_LABEL}} &rarr;</a>
        </nav>
    </header>
    <main>
        {{CONTENT}}
    </main>
    <div id="lightbox" class="lightbox">
        <span class="lightbox-close" id="lightbox-close">&times;</span>
        <div id="lightbox-content"></div>
    </div>
    <footer>On This Day &mdash; Photo Memories</footer>
    <script>
        const PLAY_SVG = '<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>';
        const photoData = window.__photoData || [];

        // Build lookup: year -> items
        const dataByYear = {};
        for (const group of photoData) dataByYear[group.year] = group.items;

        const allItems = [];
        for (const group of photoData) {
            for (const item of group.items) allItems.push(item);
        }
        let lightboxIndex = -1;

        // === Level 1: Section-level virtualization ===
        // Create/destroy card divs when year sections enter/leave viewport

        function getGridMetrics(grid) {
            const style = getComputedStyle(grid);
            const gap = parseFloat(style.gap) || parseFloat(style.rowGap) || 0;
            const cols = style.gridTemplateColumns.split(' ').length || 1;
            return { cols, gap };
        }

        function estimateGridHeight(grid, itemCount) {
            const { cols, gap } = getGridMetrics(grid);
            const rows = Math.ceil(itemCount / cols);
            // Each card is square with aspect-ratio:1, width = (gridWidth - (cols-1)*gap) / cols
            const cardSize = (grid.clientWidth - (cols - 1) * gap) / cols;
            return rows * cardSize + Math.max(0, rows - 1) * gap;
        }

        function populateSection(section) {
            const grid = section.querySelector('.photo-grid');
            if (grid.children.length > 0) return; // already populated
            const year = parseInt(section.dataset.year);
            const items = dataByYear[year];
            if (!items) return;

            const frag = document.createDocumentFragment();
            for (const item of items) {
                const card = document.createElement('div');
                card.className = item.type === 'video' ? 'photo-card video-card' : 'photo-card';
                card.dataset.id = item.id;
                card.dataset.type = item.type;
                if (item.live) card.dataset.live = '1';
                const info = document.createElement('div');
                info.className = 'photo-info';
                info.textContent = item.name;
                card.appendChild(info);
                if (item.live) {
                    const badge = document.createElement('span');
                    badge.className = 'live-badge';
                    badge.textContent = 'LIVE';
                    card.appendChild(badge);
                }
                frag.appendChild(card);
            }
            grid.appendChild(frag);

            // Start observing individual cards for media recycling
            grid.querySelectorAll('.photo-card').forEach(c => mediaRecycler.observe(c));

            // Clear estimated minHeight after layout settles to avoid scroll jumps
            requestAnimationFrame(() => { grid.style.minHeight = ''; });
        }

        function depopulateSection(section) {
            const grid = section.querySelector('.photo-grid');
            if (grid.children.length === 0) return; // already empty

            // Stop observing cards
            grid.querySelectorAll('.photo-card').forEach(c => mediaRecycler.unobserve(c));

            // Preserve height to prevent scroll jumps
            grid.style.minHeight = grid.offsetHeight + 'px';
            grid.innerHTML = '';
        }

        const sectionObserver = new IntersectionObserver((entries) => {
            for (const e of entries) {
                if (e.isIntersecting) {
                    populateSection(e.target);
                } else {
                    depopulateSection(e.target);
                }
            }
        }, { rootMargin: '200%' });

        // === Level 2: Media recycling within visible sections ===
        // Populate/depopulate img/video elements on individual cards

        function populateCard(card) {
            if (card.querySelector('a')) return;
            const id = card.dataset.id;
            const type = card.dataset.type;
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.id = id;
            a.dataset.type = type;
            a.className = 'lightbox-trigger';

            const img = document.createElement('img');
            img.src = '/photo/' + id + '/thumb';
            a.appendChild(img);

            if (type === 'video') {
                const overlay = document.createElement('div');
                overlay.className = 'video-overlay';
                overlay.innerHTML = PLAY_SVG;
                a.appendChild(overlay);
            }

            card.insertBefore(a, card.firstChild);
        }

        function depopulateCard(card) {
            const a = card.querySelector('a');
            if (a) a.remove();
        }

        const mediaRecycler = new IntersectionObserver((entries) => {
            for (const e of entries) {
                if (e.isIntersecting) {
                    populateCard(e.target);
                } else {
                    depopulateCard(e.target);
                }
            }
        }, { rootMargin: '100%' });

        // === Initialize: set estimated heights and start observing sections ===
        document.querySelectorAll('.year-section').forEach(section => {
            const year = parseInt(section.dataset.year);
            const items = dataByYear[year];
            if (items) {
                const grid = section.querySelector('.photo-grid');
                grid.style.minHeight = estimateGridHeight(grid, items.length) + 'px';
            }
            sectionObserver.observe(section);
        });

        // Recalculate heights on resize (debounced for device rotation)
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                document.querySelectorAll('.year-section').forEach(section => {
                    const grid = section.querySelector('.photo-grid');
                    if (grid.children.length === 0) {
                        const year = parseInt(section.dataset.year);
                        const items = dataByYear[year];
                        if (items) grid.style.minHeight = estimateGridHeight(grid, items.length) + 'px';
                    }
                });
            }, 150);
        });

        // === Single reusable lightbox ===
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightbox-content');

        function openLightbox(id, type, live) {
            lightboxIndex = allItems.findIndex(item => item.id === id);
            lightboxContent.innerHTML = '';
            if (live) {
                const video = document.createElement('video');
                video.src = '/photo/' + id + '/live';
                video.autoplay = true;
                video.muted = true;
                video.playsInline = true;
                video.addEventListener('ended', () => {
                    const img = document.createElement('img');
                    img.src = '/photo/' + id;
                    lightboxContent.replaceChildren(img);
                });
                lightboxContent.appendChild(video);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = '/photo/' + id;
                video.controls = true;
                video.preload = 'metadata';
                lightboxContent.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = '/photo/' + id;
                lightboxContent.appendChild(img);
            }
            document.body.style.overflow = 'hidden';
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
            lightboxContent.innerHTML = '';
            lightboxIndex = -1;
        }

        function navigateLightbox(direction) {
            if (lightboxIndex < 0) return;
            const newIndex = lightboxIndex + direction;
            if (newIndex < 0 || newIndex >= allItems.length) return;
            const item = allItems[newIndex];
            openLightbox(item.id, item.type, item.live ? '1' : null);
        }

        document.addEventListener('click', (e) => {
            const trigger = e.target.closest('.lightbox-trigger');
            if (trigger) {
                e.preventDefault();
                const card = trigger.closest('.photo-card');
                openLightbox(trigger.dataset.id, trigger.dataset.type, card && card.dataset.live);
            }
        });

        document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === 'Escape') closeLightbox();
            else if (e.key === 'ArrowLeft') navigateLightbox(-1);
            else if (e.key === 'ArrowRight') navigateLightbox(1);
        });

        // === Touch/swipe gesture handling ===
        (function() {
            let startX, startY, startTime;
            let dirLocked = null; // 'h' or 'v' once locked
            let tracking = false;

            lightbox.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) return;
                // Don't intercept touches on video controls
                if (e.target.closest('video[controls]')) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startTime = Date.now();
                dirLocked = null;
                tracking = true;
            }, { passive: true });

            lightbox.addEventListener('touchmove', (e) => {
                if (!tracking || e.touches.length > 1) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;

                // Lock direction after 10px movement
                if (!dirLocked) {
                    if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
                        dirLocked = Math.abs(dx) >= Math.abs(dy) ? 'h' : 'v';
                    } else {
                        return;
                    }
                }

                e.preventDefault();

                const el = lightboxContent.firstElementChild;
                if (!el) return;

                if (dirLocked === 'h') {
                    el.style.transform = `translateX(${dx}px)`;
                    el.style.opacity = Math.max(0.3, 1 - Math.abs(dx) / 400);
                } else {
                    // Only allow downward drag for dismiss
                    const clampedDy = Math.max(0, dy);
                    el.style.transform = `translateY(${clampedDy}px)`;
                    el.style.opacity = Math.max(0.3, 1 - clampedDy / 400);
                }
            }, { passive: false });

            lightbox.addEventListener('touchend', (e) => {
                if (!tracking) return;
                tracking = false;

                const el = lightboxContent.firstElementChild;
                if (!el || !dirLocked) return;

                const touch = e.changedTouches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;
                const dt = Date.now() - startTime;
                const velocity = dt > 0 ? Math.abs(dirLocked === 'h' ? dx : dy) / dt : 0;

                if (dirLocked === 'h') {
                    const threshold = 50;
                    if (dx < -threshold || (dx < 0 && velocity > 0.3)) {
                        navigateLightbox(1);
                        return;
                    } else if (dx > threshold || (dx > 0 && velocity > 0.3)) {
                        navigateLightbox(-1);
                        return;
                    }
                } else {
                    const threshold = 100;
                    if (dy > threshold || (dy > 0 && velocity > 0.3)) {
                        closeLightbox();
                        return;
                    }
                }

                // Snap back
                el.style.transition = 'transform 0.2s ease, opacity 0.2s ease';
                el.style.transform = '';
                el.style.opacity = '';
                el.addEventListener('transitionend', function handler() {
                    el.style.transition = '';
                    el.removeEventListener('transitionend', handler);
                }, { once: true });
            }, { passive: true });
        })();
    </script>
</body>
</html>
